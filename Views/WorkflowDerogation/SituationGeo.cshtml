@model GestionnaireUtilisateurs.Models.MultiModeles
@{
    ViewBag.Title = "SituationGeo";
    Layout = "~/Views/Shared/_LayoutDerogation.cshtml";
    bool Lire = ViewBag.Read; bool NLire = !Lire;
    bool Cree = ViewBag.Create; bool NCree = !Cree;
    bool Modifier = ViewBag.Update; bool NModifier = !Modifier;
    bool Supprimer = ViewBag.Delete; bool NSupprimer = !Supprimer;
}

<section>
    <nav>
        <ol class="cd-multi-steps text-bottom count">
            <li style="right: 2px;" class="visited"><a href="#0">Renseignements</a></li>
            <li style="right: 2px; top: 12px;" class="current"><a href="#0">Siuation Géographique</a></li>
            <li style="right: 2px;"><em>GED</em></li>
            <li style="right: 2px;"><em>Programmation</em></li>
            <li style="right: 2px;"><em>Avis</em></li>
            <li style="right: 2px;"><em>Echanges</em></li>
            <li style="right: 2px;"><em>Autorisation</em></li>
            <li style="right: 2px;"><em>Cloture</em></li>
        </ol>
    </nav>
</section>


@using GestionnaireUtilisateurs.Controllers
@{
    Html.RenderAction("Indicators", "WorkflowDerogation", new { Tache = WorkflowDerogationController._SitGeo });
}

@if (Lire)
{
    @Html.Partial("WorkflowG", Model)
    <link rel="stylesheet" href="http://localhost/arcgis_js_api/library/3.27/3.27/esri/css/esri.css">

    <div class="form-horizontal">
        @using (Html.BeginForm("SituationGeo", "WorkflowDerogation", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            <div class="card" style="box-shadow: 0 17px 41px -21px black;border-top:5px solid #09aacc">
                <h5 class="card-header">Saisie des coordonnées</h5>
                <div class="card-body">

                    <div class="form-group">
                        <dic class="row">
                            <div class="col-sm-6">
                                <input type="number" id="xx" class="form-control" placeholder="Coord. X" value="200" style="margin-bottom:10px">

                                <input type="number" id="yy" class="form-control" placeholder="Coord. Y" value="250" data-target="Entrer Y">
                                <br />
                                <button class="btn btn-space btn-primary" type="button" style="position:absolute;right:10px" id="addCoord" name="enregistrer">Ajouter coordonnées</button>
                                <br /><br /><br />
                            </div>
                            <div class="col-lg-6">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered first">
                                        <thead>
                                            <tr>
                                                <th>Points</th>
                                                <th>Coordonnées : X</th>
                                                <th>Coordonnées : Y</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyCoord"></tbody>
                                    </table>
                                </div>

                            </div>
                        </dic>


                    </div>
                </div>
            </div>
            <div class="card">
                <h5 class="card-header">Carte</h5>
                <div class="card-body" style="height:600px;box-shadow: 0 17px 41px -21px black;border-top:5px solid #09aacc;"
                     id="map">
                </div>
            </div>
            <br />
            <div class="card" style="box-shadow: 0 17px 41px -21px black;border-top:5px solid #09aacc">
                <h5 class="card-header">Couverture en documents d'urbanisme</h5>
                <div class="card-body">
                    <div class="row">

                        <div class="col-lg-6">
                            <div class="form-group">
                                <label for="inputText11" style="font-size:12px;">Couverture : </label>
                                <select class="form-control form-control-sm chzn-selec" id="selRef" name="Type_Terrain">
                                    <option value="">--- Sélectionner une réference fonciere ---</option>
                                    @foreach (var item in Model.References_Foncieres)
                                    {
                                        <option value="@item.Id_RF">@item.NomRF</option>
                                    }
                                </select>
                                <br /><br />
                                <button class="btn btn-space btn-primary" type="button" style="position:absolute;right:10px" id="addCoords">Ajouter coordonnées</button>
                                <br /><br /><br />
                            </div>

                        </div>
                        <div class="col-lg-6">
                            <div class="table-responsive">
                                <label for="inputText11" style="font-size:12px;"></label>
                                <table class="table table-striped table-bordered first">
                                    <thead>
                                        <tr>
                                            <th>Couverture</th>
                                            <th>Détail</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyCouverture"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <br /><br />

                    <div class="row">
                        <center>
                            <p class="fixed-bottom">
                                <input type="hidden" name="Id_DemDerg" value="@Model.DemDerg.Id_DemDerg" />
                                <button type="submit" class="btn btn-lg buttonsReapeateds" value="0" name="enregistrer" id="btnSave">Enregister   <i class="fa fa-level-down-alt"></i></button>
                                <button type="submit" class="btn btn-lg buttonsReapeateds" value="1" name="enregistrer" id="btnsend">Passer à l'etape suivante  <i class="fa fa-paper-plane"></i></button>
                            </p>
                        </center>
                    </div>
                    <br />
                    @Html.ActionLink("Retour a la liste des demandes", "Encours")
                    <br />
                </div>
            </div>
        }

    </div>

    @section Scripts{
        <script src="http://localhost/arcgis_js_api/library/3.27/3.27/init.js"></script>
        @*<script src="https://js.arcgis.com/3.27/"></script>
            <script>
                    require(["esri/map", "dojo/domReady!"], function (Map) {
                        var map = new Map("map", {
                            center: [-7.33, 33.5],
                            zoom: 11,
                            basemap: "topo"
                        });
                    });
                </script>*@
        <script>
            require([
    "esri/map",
    "esri/layers/FeatureLayer",
    "dojo/on",
    "esri/arcgis/utils",
    'esri/tasks/query',
    'esri/tasks/QueryTask',
    "esri/layers/FeatureLayer",
    "esri/layers/GraphicsLayer",
    "esri/tasks/GeometryService",
    "esri/SpatialReference",
    "esri/dijit/LayerList",
    "esri/dijit/Legend",
    "esri/dijit/BasemapGallery",
    "esri/graphic",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/symbols/SimpleLineSymbol",
    "esri/Color",
    "esri/toolbars/draw",
    "esri/symbols/SimpleFillSymbol",
    "esri/geometry/Polygon",
    "esri/geometry/Point",
    "esri/dijit/HomeButton",
    "esri/geometry/geometryEngine",
    "dojo/domReady!"],
function (
    Map,
    FeatureLayer,
    on,
    arcgisUtils,
    Query,
    QueryTask,
    FeatureLayer,
    GraphicsLayer,
    GeometryService,
    SpatialReference,
    LayerList,
    Legend,
    BasemapGallery,
    Graphic,
    SimpleMarkerSymbol,
    SimpleLineSymbol,
    Color,
    Draw,
    SimpleFillSymbol,
    Polygon,
    Point,
    HomeButton,
    geometryEngine
) {


    //var map = new Map("map", {
    //    basemap: "topo",
    //    autoResize: "autoResize",
    //    center: [-7, 35.6122],
    //    zoom: 5
    //});

    var map;
    var array = [];
    var graphicLayer = new GraphicsLayer();
    arcgisUtils.arcgisUrl = "https://si.aurs.org.ma/portal/sharing/content/items";
    arcgisUtils.createMap("fe0cf9e1c18f44388cae869a212d72de", "map").then(function (response) {
        //update the app
        // dom.byId("title").innerHTML = response.itemInfo.item.title;
        // dom.byId("subtitle").innerHTML = response.itemInfo.item.snippet;

        map = response.map;

        var legendLayers = arcgisUtils.getLegendLayers(response);

        var legendDijit = new Legend({
            map: map,
            layerInfos: legendLayers
        }, "legend");
        legendDijit.startup();

        var layerList = new LayerList({
            map: response.map,
            layers: arcgisUtils.getLayerList(response)
        }, "layerList");
        layerList.startup();

        var basemapGallery = new BasemapGallery({
            showArcGISBasemaps: true,
            map: map
        }, "basemapGallery");
        basemapGallery.startup();

        basemapGallery.on("load", function () {
            var tot = basemapGallery.basemaps.length;
            for (var i = 0; i < tot + 1; i++) {
                if (basemapGallery.basemaps[i].title === "Canevas gris foncé"
                    || basemapGallery.basemaps[i].title === "Streets (Night)"
                    || basemapGallery.basemaps[i].title == "Nuances de gris"
                    || basemapGallery.basemaps[i].title === "Navigation"
                    || basemapGallery.basemaps[i].title === "Océans et bathymétrie") {
                    basemapGallery.remove(basemapGallery.basemaps[i].id);
                }
            }
        });

        graphicLayer.on('click', function (e) {
            $("#tbodyCoord tr").remove();
            array = [];
            gsvc = new GeometryService("https://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");

            var pointsGraphic = e.graphic.geometry.rings[0];
            //console.log(features_parcellaire[0].geometry);
            for (var i = 0; i < pointsGraphic.length - 1; i++) {
                var x = pointsGraphic[i][0];
                var y = pointsGraphic[i][1];
                array.push([x, y]);
                var wkid = new SpatialReference(4326);
                pt = new Point(x, y, wkid);
                var wkid1 = new SpatialReference(26191);

                gsvc.project([pt], wkid1, function (projectPoint) {
                    var p = projectPoint[0];
                    // array.push([p.x, p.y]);
                    var table = document.getElementById('tbodyCoord');
                    var row = table.insertRow(table.length);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);
                    var cell4 = row.insertCell(3);
                    cell1.innerHTML = "B" + table.rows.length;
                    cell2.innerHTML = p.x.toFixed(3);
                    cell3.innerHTML = p.y.toFixed(3);
                    var btn = document.createElement("input");
                    btn.setAttribute("id", table.rows.length);
                    btn.setAttribute("src", "../Content/documentation/img/modif.png");
                    btn.setAttribute("type", "image");
                    btn.setAttribute("name", "update");
                    btn.onclick = function () {
                        var id = this.id;
                        cell2.innerHTML = "<input type='text' class='form-control' id='new_lon' value='"
                            + table.rows[id - 1].cells[1].innerHTML + "'/>";
                        cell3.innerHTML = "<input type='text' class='form-control' id='new_lat' value='"
                            + table.rows[id - 1].cells[2].innerHTML + "'/>";


                        var valider = document.createElement('input');
                        valider.setAttribute('src', "../Content/documentation/img/valid.png");
                        valider.setAttribute('id', table.rows.length);
                        valider.setAttribute('type', "image");
                        valider.onclick = function () {
                            var a = document.getElementById('new_lon').value.replace(",", ".");
                            var b = document.getElementById('new_lat').value.replace(",", ".");
                            cell2.innerHTML = document.getElementById('new_lon').value.replace(",", ".");
                            cell3.innerHTML = document.getElementById('new_lat').value.replace(",", ".");
                            var pt2 = new Point(a, b, wkid);
                            gsvc.project([pt2], wkid1, function (projectPoint) {
                                var p2 = projectPoint[0];
                                array[id - 1] = [p2.x, p2.y];
                            });
                            cell4.removeChild(valider); cell4.removeChild(btn1);
                            cell4.appendChild(btn);
                        }


                        var btn1 = document.createElement('input');
                        btn1.setAttribute("src", "../Content/documentation/img/del.png");
                        btn1.setAttribute("type", "image");
                        btn1.setAttribute("id", id);
                        btn1.setAttribute("name", "delete");
                        btn1.onclick = function () {
                            if (table.rows.length > btn1.getAttribute('id')) {
                                table.deleteRow(id - 1);
                                array.splice(id - 1, 1);
                                var x1 = parseInt(id) - 1;
                                for (var i = x1; i < table.rows.length + 1; i++) {
                                    var j = document.getElementsByName("update")[i].getAttribute('id');
                                    var k = i + 1;
                                    table.rows[i].cells[0].innerHTML = "B" + k;
                                    document.getElementsByName("update")[i].setAttribute('id', j - 1);
                                }
                            }
                            if (table.rows.length <= btn1.getAttribute('id') && table.rows.length > 1) { table.deleteRow(id - 1); array.splice(id - 1, 1); }
                            if (table.rows.length <= btn1.getAttribute('id') && table.rows.length == 1) {
                                table.deleteRow(id - 1); array.splice(id - 1, 1);
                                document.getElementById('vider').disabled = true;
                            }
                        }
                        cell4.removeChild(btn);
                        cell4.appendChild(valider);
                        cell4.appendChild(btn1);
                    }
                    cell4.appendChild(btn);
                });
            }
        });

        //add the scalebar
        var scalebar = new Scalebar({
            map: map,
            scalebarUnit: "english"
        });

        //add the legend. Note that we use the utility method getLegendLayers to get
        //the layers to display in the legend from the createMap response.
        var legendLayers = arcgisUtils.getLegendLayers(response);
        var legendDijit = new Legend({
            map: map,
            layerInfos: legendLayers
        }, "legend");
        legendDijit.startup();
    });

    /****************************************************************
        * Add feature layer - A FeatureLayer at minimum should point
        * to a URL to a feature service or point to a feature collection
        * object.
        ***************************************************************/

    // Carbon storage of trees in Warren Wilson College.  
    var xCenteroidF;
    var yCenteroidF;



    document.getElementById('selRef').onchange = function () {
        var typeFonc = document.getElementById('selRef').value;
        var numFonc = document.getElementById('numfonc').value;
        var indice = document.getElementById('indice').value;
        var fraction = document.getElementById('fraction').value;
        document.getElementById('indice').disabled = false;
        if (typeFonc == 'TF') {
            document.getElementById('coordInputs').style.display = 'none';
            document.getElementById('refInputs').style.display = 'block';
            $('#indice').prop('disabled', false).trigger("liszt:updated");
        } else if (typeFonc == 'Req') {
            document.getElementById('coordInputs').style.display = 'none';
            document.getElementById('refInputs').style.display = 'block';
            document.getElementById('indice').value = "";
            //$('#indice').prop('disabled', true).trigger("liszt:updated");

        } else if (typeFonc == 'TNI') {
            document.getElementById('coordInputs').style.display = 'block';
            document.getElementById('refInputs').style.display = 'none';
        }
    }

    //document.getElementById('localiser').onclick = Localiser();
    $("#localiser").click(Localiser());


    document.getElementById('addCoord').onclick = function () {

        gsvc = new GeometryService("https://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");
        var x = document.getElementById('xx');
        var y = document.getElementById('yy');
        var wkid = new SpatialReference(26191);
        if (x.value != "" && y.value != "") {

            pt = new Point(x.value.replace(",", "."), y.value.replace(",", "."), wkid);

            var wkid1 = new SpatialReference(3857);
            map.setZoom(15);
            gsvc.project([pt], wkid1, function (projectPoint) {

                console.log(projectPoint);
                var p = projectPoint[0];
                /////Zoom to Added point
                var sym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_SQUARE, 10,
                    new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
                        new Color([255, 0, 0]), 1),
                    new Color([0, 255, 0, 0.25]));
                var graphic2 = new Graphic(p, sym);
                map.graphics.add(graphic2);

                map.centerAt(p);

                ///////////////////////
                array.push([p.x, p.y]);
                var table = document.getElementById('tbodyCoord');
                var row = table.insertRow(table.length);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                var cell4 = row.insertCell(3);
                cell1.innerHTML = "B" + table.rows.length;
                cell2.innerHTML = x.value.replace(",", ".");
                cell3.innerHTML = y.value.replace(",", ".");
                var btn = document.createElement("input");
                btn.setAttribute("id", table.rows.length);
                btn.setAttribute("src", "../Content/documentation/img/modif.png");
                btn.setAttribute("type", "image");
                btn.setAttribute("name", "update");
                btn.onclick = function () {
                    var id = this.id;
                    cell2.innerHTML = "<input type='text' class='form-control' id='new_lon' value='" + table.rows[id - 1].cells[1].innerHTML + "'/>";
                    cell3.innerHTML = "<input type='text' class='form-control' id='new_lat' value='" + table.rows[id - 1].cells[2].innerHTML + "'/>";


                    var valider = document.createElement('input');
                    valider.setAttribute('src', "../Content/documentation/img/valid.png");
                    valider.setAttribute('id', table.rows.length);
                    valider.setAttribute('type', "image");
                    valider.onclick = function () {
                        var a = document.getElementById('new_lon').value.replace(",", ".");
                        var b = document.getElementById('new_lat').value.replace(",", ".");
                        cell2.innerHTML = document.getElementById('new_lon').value.replace(",", ".");
                        cell3.innerHTML = document.getElementById('new_lat').value.replace(",", ".");
                        var pt2 = new Point(a, b, wkid);
                        gsvc.project([pt2], wkid1, function (projectPoint) {
                            var p2 = projectPoint[0];
                            array[id - 1] = [p2.x, p2.y];
                        });
                        cell4.removeChild(valider); cell4.removeChild(btn1);
                        cell4.appendChild(btn);
                    }


                    var btn1 = document.createElement('input');
                    btn1.setAttribute("src", "../Content/documentation/img/del.png");
                    btn1.setAttribute("type", "image");
                    btn1.setAttribute("id", id);
                    btn1.setAttribute("name", "delete");
                    btn1.onclick = function () {
                        if (table.rows.length > btn1.getAttribute('id')) {
                            table.deleteRow(id - 1);
                            array.splice(id - 1, 1);
                            var x1 = parseInt(id) - 1;
                            for (var i = x1; i < table.rows.length + 1; i++) {
                                var j = document.getElementsByName("update")[i].getAttribute('id');
                                var k = i + 1;
                                table.rows[i].cells[0].innerHTML = "B" + k;
                                document.getElementsByName("update")[i].setAttribute('id', j - 1);
                            }
                        }
                        if (table.rows.length <= btn1.getAttribute('id') && table.rows.length > 1) { table.deleteRow(id - 1); array.splice(id - 1, 1); }
                        if (table.rows.length <= btn1.getAttribute('id') && table.rows.length == 1) {
                            table.deleteRow(id - 1); array.splice(id - 1, 1);
                            document.getElementById('vider').disabled = true;
                        }
                    }
                    cell4.removeChild(btn);
                    cell4.appendChild(valider);
                    cell4.appendChild(btn1);
                }
                cell4.appendChild(btn);
                x.value = "";
                y.value = "";
                x.style.boxShadow = "";
                y.style.boxShadow = "";
            });
        }
        else {
            alert("veuillez saisir les coordonnees!!");
        }
    }


    document.getElementById('alimBD').onclick = function () {

        var typeFonc = document.getElementById('selRef').value;
        var numFonc = document.getElementById('numfonc').value;
        var indice = document.getElementById('indice').value;
        var fraction = document.getElementById('fraction').value;
        var complement = document.getElementById("complement").value;
        var sym = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
            new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT,
                new Color([255, 0, 0]), 2), new Color([255, 255, 255, 0.15])
        );

        if (typeFonc == 'TNI') {
            var pol = new Polygon(array);

            gsvc = new GeometryService("https://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");
            var wkid = new SpatialReference(26191);
            pt = new Point(pol.getCentroid().x, pol.getCentroid().y, wkid);
            var wkid1 = new SpatialReference(3857);
            gsvc.project([pt], wkid1, function (projectPoint) {
                var p = projectPoint[0];
                var f = new FeatureLayer("https://si.aurs.org.ma/server/rest/services/PARCELLAIRE/FeatureServer/0");
                var xCenteroid = p.x.toFixed(3).replace(".", ",");
                var yCenteroid = p.y.toFixed(3).replace(".", ",");
                attr = { "typefoncier": typeFonc, "x": xCenteroid, "y": yCenteroid };
                var graphic = new Graphic(pol, sym, attr);
                f.applyEdits([graphic], null, null, function () {
                    Localiser();
                });

            });
        } else {
            array = [];
            array.push([-746530.0130604643, 4017850.880879946]);
            array.push([-746503.3819100509, 4017862.1044801027]);
            array.push([-746439.371403158, 4017961.4527203813]);


            var pol = new Polygon(array);
            var sr = new SpatialReference(3857);
            pol.setSpatialReference(sr);
            //array = [];
            console.log(pol);

            var f = new FeatureLayer("https://si.aurs.org.ma/server/rest/services/PARCELLAIRE/FeatureServer/0", { outFields: ["*"] });
            attr = { "typefoncier": typeFonc, "numfoncier": numFonc, "indice": indice, "fraction": fraction };
            //  attr = { "OBJECTID": 10054, "typefoncier": typeFonc, "numfoncier": numFonc, "indice": indice, "fraction": fraction, "complement": complement };
            attr = { "typefoncier": typeFonc, "numfoncier": numFonc, "indice": indice, "fraction": fraction, "complement": complement };
            // var graphic = new Graphic([pol], null, null);



            //var feature = [];      
            //var attr = {};
            //attr["typefoncier"] = typeFonc;  
            //var graphic = new Graphic([pol]);
            //graphic.setAttributes(attr);
            //feature.push(graphic);


            //console.log(feature);
            gsvc = new GeometryService("http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");
            var sr = new SpatialReference(102100);
            gsvc.project([pol], sr, function (projectpol) {
                var poly = projectpol[0];
                var graphic = new Graphic([poly], null, null);

                f.applyEdits([graphic], null, null, function (res) {
                    console.log(res);
                    Localiser();
                    alert('C est Bon');
                }, function (err) {
                    console.log('Error occured: ', err);
                    alert('Error');
                });
            });
            map.graphics.clear();
            $("#tbodyCoord tr").remove();
            $('alimBD').hide();
        }
    }

    //document.getElementById('btnPetitionnaire').onclick = function () {        
    //    var btnValue = document.getElementById('btnPetitionnaire').value;
    //    if (btnValue == 1) {
    //        document.getElementById('divPetitionnaire').style.display = "none";
    //        document.getElementById('btnPetitionnaire').value = 0;
    //        document.getElementById('imgbtnPetitionnaire').setAttribute('src', '../Content/documentation/img/plusicon.png');
    //        document.getElementById('inputPetFr').value = "";
    //        document.getElementById('inputPetAr').value = "";
    //        document.getElementById('inputCIN').value = "";
    //        document.getElementById('inputMail').value = "";
    //        document.getElementById('inputTel').value = "";
    //    }else if (btnValue == 0) {
    //        document.getElementById('divPetitionnaire').style.display = "block";
    //        document.getElementById('btnPetitionnaire').value = 1;
    //        document.getElementById('imgbtnPetitionnaire').setAttribute('src', '../Content/documentation/img/minusicon.png');
    //        document.getElementById("petFrance").selectedIndex = "0";
    //        document.getElementById("petArabe").selectedIndex = "0";
    //    }
    //}


    document.getElementById('vider').onclick = function () {
        document.getElementById('error').style.display = 'none'
        document.getElementById('xx').value = "";
        document.getElementById('yy').value = "";
        document.getElementById('numfonc').value = "";
        document.getElementById('indice').value = "";
        document.getElementById('selRef').selectedIndex = "0";
        array = [];
        map.graphics.clear();
        $("#tbodyCoord tr").remove();
    }

    $('#testBtn').click(function () {
        if ($('#testBtn').val() == "0") {
            $('#testBtn').val("1");

        } else {
            $('#testBtn').val("0");
        }

        if ($('#testBtn1').val() == "1") {
            $('.divHide1').slideToggle("fast");
            $('#testBtn1').val("0");
        }
        if ($('#testBtn2').val() == "1") {
            $('.divHide2').slideToggle("fast");
            $('#testBtn2').val("0");
        }

        $('.divHide').slideToggle("fast");
    });

    $(document).ready(function () {
        $('#testBtn1').click(function () {
            if ($('#testBtn1').val() == "0") {
                $('#testBtn1').val("1");

            } else {
                $('#testBtn1').val("0");
            }

            if ($('#testBtn').val() == "1") {
                $('.divHide').slideToggle("fast");
                $('#testBtn').val("0");
            }
            if ($('#testBtn2').val() == "1") {
                $('.divHide2').slideToggle("fast");
                $('#testBtn2').val("0");
            }

            $('.divHide1').slideToggle("fast");
        });
    });

    $(document).ready(function () {
        $('#testBtn2').click(function () {
            if ($('#testBtn2').val() == "0") {
                $('#testBtn2').val("1");

            } else {
                $('#testBtn2').val("0");
            }

            if ($('#testBtn').val() == "1") {
                $('.divHide').slideToggle("fast");
                $('#testBtn').val("0");
            }
            if ($('#testBtn1').val() == "1") {
                $('.divHide1').slideToggle("fast");
                $('#testBtn1').val("0");
            }
            $('.divHide2').slideToggle("fast");
        });

    });

    $(document).ready(function () {
        $('#btnBasemap').click(function () {
            $('.divHide').slideToggle("fast");
            $('#testBtn').val("0");
        });
    });

    $(document).ready(function () {
        $('#btnLayerList').click(function () {
            $('.divHide1').slideToggle("fast");
            $('#testBtn1').val("0");
        });
    });

    $(document).ready(function () {
        $('#btnLegend').click(function () {
            $('.divHide2').slideToggle("fast");
            $('#testBtn2').val("0");
        });
    });


    document.getElementById('nvDemande').onclick = function () {
        var typeFonc = document.getElementById('selRef').value;
        var numFonc = document.getElementById('numfonc').value;
        var indice = document.getElementById('indice').value;
        document.getElementById('')
        sessionStorage.setItem("typeFoncier", typeFonc);
        if (typeFonc == 'TNI') {
            sessionStorage.setItem("xCenteroid", xCenteroidF);
            sessionStorage.setItem("yCenteroid", yCenteroidF);
            location.replace("http://localhost/aurs/pages/cards.html");
        } else {
            sessionStorage.setItem("numFoncier", numFonc);
            sessionStorage.setItem("indice", indice);
            location.replace("http://localhost/aurs/pages/cards.html");

        }

    }



    function Localiser() {

        graphicLayer.clear();
        document.getElementById('coordInputs').style.display = 'none';
        document.getElementById('xx').value = "";
        document.getElementById('yy').value = "";
        array = [];
        map.graphics.clear();
        $("#tbodyCoord tr").remove();
        var petFr = document.getElementById('petFrance').value;
        var petAr = document.getElementById('petArabe').value;
        var typeFonc = document.getElementById('selRef').value;
        var numFonc = document.getElementById('numfonc').value;
        var indice = document.getElementById('indice').value;
        var fraction = document.getElementById('fraction').value;
        var complement = document.getElementById("complement").value;
        map.graphics.clear();
        if (typeFonc == "" || (petFr == "" && petAr == "")) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = "Merci de remplire tous les champs nécessaires"
        }
        else {
            document.getElementById('error').style.display = 'none';
            if (array.length != 0) {
                console.log(array);
                if (array.length == 1) {
                    var sym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_SQUARE, 10,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
                            new Color([255, 0, 0]), 1),
                        new Color([0, 255, 0, 0.25]));
                    var sym1 = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT,
                            new Color([255, 0, 0]), 2), new Color([255, 255, 255, 0.15])
                    );
                    map.graphics.clear();

                    var pt = new Point(array[0][0], array[0][1]);

                    console.log(pt);
                    featureLeyr_parc = new FeatureLayer("https://si.aurs.org.ma/server/rest/services/PARCELLAIRE/MapServer/0");
                    q_parc = new Query();
                    q_parc.outFields = ["*"];
                    q_parc.returnGeometry = true;
                    q_parc.where = "typefoncier = 'TNI'";
                    featureLeyr_parc.queryFeatures(q_parc, function (featureSet) {
                        featuresParc = featureSet.features;
                        for (var i = 0; i < featuresParc.length; i++) {
                            console.log(pt); console.log(featuresParc[i].geometry);
                            if (geometryEngine.intersects(pt, featuresParc[i].geometry) == true) {
                                var graphic2 = new Graphic(featuresParc[i].geometry, sym1);
                                graphicLayer.add(graphic2);
                            }
                        }
                        map.addLayer(graphicLayer);
                    });
                    var graphic2 = new Graphic(pt, sym);
                    map.graphics.add(graphic2);
                    map.centerAndZoom(pt, 17);
                } else {
                    var sym = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT,
                            new Color([255, 0, 0]), 2), new Color([255, 255, 255, 0.15])
                    );
                    map.graphics.clear();
                    var pol = new Polygon(array);
                    gsvc = new GeometryService("http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");
                    var wkid = new SpatialReference(4326);

                    pt = new Point(pol.getCentroid().x, pol.getCentroid().y, wkid);
                    var wkid1 = new SpatialReference(26191);
                    gsvc.project([pt], wkid1, function (projectPoint) {
                        var p = projectPoint[0];
                        var xCenteroid = p.x.toFixed(3).replace(".", ","); console.log(xCenteroid);
                        var yCenteroid = p.y.toFixed(3).replace(".", ","); console.log(yCenteroid);
                        xCenteroidF = p.x.toFixed(3);
                        yCenteroidF = p.y.toFixed(3);
                        var graphic2 = new Graphic(pol, sym);
                        map.graphics.add(graphic2);
                        var extent = pol.getExtent().expand(2);
                        map.setExtent(extent);
                        q_parcellaire = new QueryTask("https://si.aurs.org.ma/server/rest/services/PARCELLAIRE/MapServer/0");
                        q_p = new Query();
                        q_p.outFields = ["*"];
                        q_p.returnGeometry = true;
                        q_p.where = "typefoncier = '" + typeFonc + "' AND x  = '" + xCenteroid + "' AND y  ='" + yCenteroid + "'";
                        q_parcellaire.execute(q_p, result);
                        function result(featureSet) {
                            var features_parcellaire = featureSet.features;
                            if (features_parcellaire.length != 0) {
                                var graphic2 = new Graphic(features_parcellaire[0].geometry, sym);
                                map.graphics.add(graphic2);
                                var extent = features_parcellaire[0].geometry.getExtent().expand(2);
                                map.setExtent(extent);
                                document.getElementById('alimBD').style.display = 'none';
                                document.getElementById('idparcellaire').value = features_parcellaire[0].attributes['OBJECTID'];
                                featureLeyr_Comm = new FeatureLayer("https://si.aurs.org.ma/server/rest/services/PARCELLAIRE/MapServer/0");
                                q_Comm = new Query();
                                q_Comm.outFields = ["*"];
                                q_Comm.returnGeometry = true;
                                q_Comm.geometry = features_parcellaire[0].geometry;
                                featureLeyr_Comm.queryFeatures(q_Comm, function (featureSet) {
                                    featuresComm = featureSet.features;
                                    document.getElementById('idprov').value = featuresComm[0].attributes['id_prov'];
                                    document.getElementById('idcommune').value = featuresComm[0].attributes['id_commune'];
                                });
                                featureLeyr_PA = new FeatureLayer("https://si.aurs.org.ma/server/rest/services/PARCELLAIRE/MapServer/0");
                                q_PA = new Query();
                                q_PA.outFields = ["*"];
                                q_PA.returnGeometry = true;
                                q_PA.geometry = features_parcellaire[0].geometry;
                                featureLeyr_PA.queryFeatures(q_PA, function (featureSet) {
                                    featuresPA = featureSet.features;
                                    document.getElementById('idPa').value = featuresPA[0].attributes['objectid'];
                                });
                            } else {
                                document.getElementById('alimBD').style.display = 'inline';
                                document.getElementById('coordInputs').style.display = 'block';
                                document.getElementById('error').style.display = 'block';
                            }
                        }
                    });
                }
            } else {
                if (numFonc != "") {

                    var sym = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT,
                            new Color([255, 0, 0]), 2), new Color([255, 255, 255, 0.15])
                    );
                    q_parcellaire = new QueryTask("https://si.aurs.org.ma/server/rest/services/PARCELLAIRE/MapServer/0");
                    q_p = new Query();
                    q_p.outFields = ["*"];
                    q_p.returnGeometry = true;

                    q_p.where = "typefoncier = '" + typeFonc + "' AND numfoncier = '" + numFonc + "' AND indice = '" + indice + "' AND fraction ='" + fraction + "' AND complement='" + complement + "'";
                    q_parcellaire.execute(q_p, result);
                    function result(featureSet) {
                        var features_parcellaire = featureSet.features;

                        if (features_parcellaire.length != 0) {
                            var graphic2 = new Graphic(features_parcellaire[0].geometry, sym);
                            map.graphics.add(graphic2);
                            var extent = features_parcellaire[0].geometry.getExtent().expand(2);
                            map.setExtent(extent);
                            document.getElementById('idparcellaire').value = features_parcellaire[0].attributes['OBJECTID'];
                            featureLeyr_Comm = new FeatureLayer("https://si.aurs.org.ma/server/rest/services/ZONE_AURS/MapServer/0");
                            q_Comm = new Query();
                            q_Comm.outFields = ["*"];
                            q_Comm.returnGeometry = true;
                            q_Comm.geometry = features_parcellaire[0].geometry;
                            featureLeyr_Comm.queryFeatures(q_Comm, function (featureSet) {
                                featuresComm = featureSet.features;
                                document.getElementById('idprov').value = featuresComm[0].attributes['prefecture'];
                                document.getElementById('idcommune').value = featuresComm[0].attributes['objectid'];
                            });
                            featureLeyr_PA = new FeatureLayer("https://si.aurs.org.ma/server/rest/services/ZONE_AURS/MapServer/0");
                            q_PA = new Query();
                            q_PA.outFields = ["*"];
                            q_PA.returnGeometry = true;
                            q_PA.geometry = features_parcellaire[0].geometry;
                            featureLeyr_PA.queryFeatures(q_PA, function (featureSet) {
                                featuresPA = featureSet.features;
                                document.getElementById('idPa').value = featuresPA[0].attributes['objectid'];
                            });
                        } else {
                            document.getElementById('alimBD').style.display = 'inline';
                            document.getElementById('coordInputs').style.display = 'block';
                            document.getElementById('error').style.display = 'block';
                        }
                    }
                } else {
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').innerHTML = "Merci de remplire tous les champs nécessaires";
                }
            }
        }
    }
});

        </script>

    }
}
else
{
    <div class="card" style="box-shadow: 0 17px 41px -21px black;border-top:5px solid #09aacc">
        <div class="card-body">
            <center>
                <label class="text-danger">
                    <span>
                        <i class="fa fa-accessible-icon"></i>
                        <strong>
                            Vous n'avez pas le droit d'afficher cette information
                        </strong>
                    </span>
                </label>
            </center>
            <br />@Html.ActionLink("Retour a la liste des demandes", "Encours")<br />
        </div>
    </div>
}

